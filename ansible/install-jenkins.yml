---
# Ansible Playbook: Install and Configure Jenkins
# Single instance setup - Jenkins runs on the same server as the application
# Run this after terraform apply to set up Jenkins

- name: Install Jenkins on Single Instance
  hosts: servers
  become: yes
  gather_facts: yes

  vars:
    jenkins_home: /var/lib/jenkins

  tasks:
    # ==========================================
    # STEP 1: SYSTEM PREPARATION
    # ==========================================
    - name: Display installation info
      debug:
        msg:
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "ğŸš€ Installing Jenkins on Single Instance"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "Host: {{ ansible_host }}"
          - "This server will run: Jenkins + Application"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    # ==========================================
    # STEP 2: INSTALL JENKINS PREREQUISITES
    # ==========================================
    - name: Ensure Java 17 is installed
      apt:
        name: openjdk-17-jdk
        state: present

    - name: Add Jenkins GPG key
      apt_key:
        url: https://pkg.jenkins.io/debian-stable/jenkins.io-2023.key
        state: present

    - name: Add Jenkins repository
      apt_repository:
        repo: "deb https://pkg.jenkins.io/debian-stable binary/"
        state: present
        filename: jenkins

    # ==========================================
    # STEP 3: INSTALL JENKINS
    # ==========================================
    - name: Install Jenkins
      apt:
        name: jenkins
        state: present
        update_cache: yes

    - name: Ensure Jenkins service is started and enabled
      systemd:
        name: jenkins
        state: started
        enabled: yes

    - name: Wait for Jenkins to start
      wait_for:
        port: 8080
        delay: 10
        timeout: 120

    # ==========================================
    # STEP 4: GET INITIAL PASSWORD
    # ==========================================
    - name: Get Jenkins initial admin password
      slurp:
        src: "{{ jenkins_home }}/secrets/initialAdminPassword"
      register: jenkins_admin_pwd
      ignore_errors: yes

    - name: Store initial password for later display
      set_fact:
        jenkins_password: "{{ jenkins_admin_pwd['content'] | b64decode }}"
      when: jenkins_admin_pwd is succeeded

    # ==========================================
    # STEP 5: CONFIGURE DOCKER ACCESS
    # ==========================================
    - name: Add jenkins user to docker group
      user:
        name: jenkins
        groups: docker
        append: yes

    - name: Restart Jenkins to apply docker group
      systemd:
        name: jenkins
        state: restarted

    - name: Wait for Jenkins to restart
      wait_for:
        port: 8080
        delay: 10
        timeout: 60

    # ==========================================
    # STEP 6: INSTALL ADDITIONAL TOOLS
    # ==========================================
    - name: Ensure required tools are installed
      apt:
        name:
          - ansible
          - git
          - curl
          - jq
        state: present

    # ==========================================
    # STEP 7: INSTALLATION SUMMARY
    # ==========================================
    - name: Get Jenkins version
      shell: jenkins --version
      register: jenkins_version
      ignore_errors: yes

    - name: Jenkins Installation Summary
      debug:
        msg:
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "ğŸ‰ JENKINS INSTALLED SUCCESSFULLY!"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "ğŸ“ Access URLs:"
          - "   Jenkins:  http://{{ ansible_host }}:8080"
          - "   Frontend: http://{{ ansible_host }}:3000 (after deploy)"
          - "   Backend:  http://{{ ansible_host }}:4000 (after deploy)"
          - ""
          - "ğŸ”‘ Initial Admin Password:"
          - "   {{ jenkins_password | default('Check /var/lib/jenkins/secrets/initialAdminPassword') }}"
          - ""
          - "ğŸ“‹ Next Steps:"
          - "   1. Open Jenkins URL in browser"
          - "   2. Enter the initial admin password"
          - "   3. Install suggested plugins"
          - "   4. Create admin user"
          - "   5. Add GitHub credentials"
          - "   6. Create pipeline job"
          - ""
          - "ğŸ’¡ Jenkins Version: {{ jenkins_version.stdout | default('Unknown') }}"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
